{% extends 'base.html' %}

{% block title %}Data Analysis{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    /* Share Modal 样式 */
    .modal-content {
        background-color: #c69c6d; /* 棕色背景，与图片匹配 */
        border-radius: 8px;
        padding: 15px;
    }
    
    .modal-header {
        border-bottom: none;
        padding-bottom: 0;
    }
    
    .modal-title {
        width: 100%;
        text-align: center;
        font-size: 24px;
        color: #000;
    }
    
    .modal-body {
        padding: 20px 15px;
    }
    
    .section-title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .radio-option {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .radio-option input[type="radio"] {
        margin-right: 10px;
        transform: scale(1.2);
    }
    
    .select-container {
        position: relative;
        margin-bottom: 15px;
    }
    
    .form-select {
        border-radius: 20px;
        padding: 10px;
    }
    
    .selected-users {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    
    .user-tag {
        display: flex;
        align-items: center;
        background-color: white;
        border-radius: 20px;
        padding: 5px 12px;
        font-size: 14px;
    }
    
    .remove-user {
        margin-left: 8px;
        cursor: pointer;
        color: #888;
        font-size: 16px;
    }
    
    .modal-footer {
        border-top: none;
        justify-content: center;
        padding-top: 0;
    }
    
    .btn-done {
        background-color: #26a69a; /* 使用图片中的绿松石色 */
        color: white;
        border-radius: 20px;
        padding: 8px 30px;
    }
    
    .btn-cancel {
        background-color: white;
        color: black;
        border-radius: 20px;
        padding: 8px 30px;
    }
    
    /* 调整分享按钮的样式，使其与图片中的按钮匹配 */
    .share-btn {
        background-color: #C38D60; /* 棕色按钮 */
        border: none;
        border-radius: 20px;
        padding: 8px 30px;
        color: white;
        font-size: 16px;
    }
    
    .share-btn:hover {
        background-color: #b07a50;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-center mb-5" style="color: #C38D60;">Data Analysis</h1>
    
    <!-- Summary Cards -->
    <div class="row mb-5">
        <div class="col-md-3">
            <div class="card summary-card" style="background-color: #F3E7DD; border: none; border-radius: 10px;">
                <div class="card-body text-center">
                    <h5 class="card-title">Total Duration(Minutes)</h5>
                    <p class="card-text display-4" style="color: #C38D60;">50</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card summary-card" style="background-color: #F3E7DD; border: none; border-radius: 10px;">
                <div class="card-body text-center">
                    <h5 class="card-title">Today Learning (Minutes)</h5>
                    <p class="card-text display-4" style="color: #C38D60;">20</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card summary-card" style="background-color: #F3E7DD; border: none; border-radius: 10px;">
                <div class="card-body text-center">
                    <h5 class="card-title">Average Duration(Minutes)</h5>
                    <p class="card-text display-4" style="color: #C38D60;">15</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card summary-card" style="background-color: #F3E7DD; border: none; border-radius: 10px;">
                <div class="card-body text-center">
                    <h5 class="card-title">Today Learning (Minutes)</h5>
                    <p class="card-text display-4" style="color: #C38D60;">20</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="filter-section">
                <p class="filter-label" style="color: #C38D60;">Filter : This Month</p>
            </div>
        </div>
        <div class="col-md-6 text-end">
            <div class="filter-section">
                <p class="filter-label" style="color: #C38D60;">Filter : This Month</p>
            </div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="row mb-5">
        <div class="col-md-6">
            <div class="chart-container">
                <canvas id="studyPlanChart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <canvas id="studyDurationChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Share Button -->
    <div class="row mb-5">
        <div class="col-12 text-center">
            <button type="button" class="btn share-btn" data-bs-toggle="modal" data-bs-target="#shareModal">
                Share
            </button>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">Share Your Study Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="shareForm">
                    <div class="mb-4">
                        <h3 class="section-title">1. Select data you want to share</h3>
                        <div class="radio-option">
                            <input type="radio" id="totalStudyTime" name="dataType" value="totalStudyTime" checked>
                            <label for="totalStudyTime">Total study time</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="averageStudyTime" name="dataType" value="averageStudyTime">
                            <label for="averageStudyTime">Average study time</label>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="section-title">2. Select users you want to share</h3>
                        <div class="select-container">
                            <select class="form-select" id="userSelect">
                                <option value="" disabled selected>Select users</option>
                                <option value="alice">Alice</option>
                                <option value="bob">Bob</option>
                                <option value="celia">Celia</option>
                                <option value="david">David</option>
                                <option value="betty">Betty</option>
                            </select>
                        </div>
                        
                        <div class="selected-users" id="selectedUsers">
                            <div class="user-tag">
                                Celia
                                <span class="remove-user" data-user="celia">✕</span>
                            </div>
                            <div class="user-tag">
                                Betty
                                <span class="remove-user" data-user="betty">✕</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-done" id="doneButton">Done</button>
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- 确保先加载依赖库 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 确保页面完全加载后再执行脚本
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化图表
        initCharts();
        
        // 设置分享按钮点击事件
        // setupShareButton();
        
        // 设置用户选择功能
        setupUserSelection();
        
        // 设置Done按钮点击事件
        setupDoneButton();
    });
    
    // 初始化图表
    function initCharts() {
        // 饼图 - 学习计划状态
        const planStatusChart = new Chart(
            document.getElementById('studyPlanChart').getContext('2d'),
            {
                type: 'pie',
                data: {
                    labels: ['Open', 'Completed', 'Deleted', 'In Progress', 'Late'],
                    datasets: [{
                        data: [5, 3, 1, 4, 2],
                        backgroundColor: [
                            'rgba(23, 96, 120, 0.9)',
                            'rgba(40, 140, 160, 0.9)',
                            'rgba(70, 190, 180, 0.9)',
                            'rgba(40, 210, 170, 0.9)',
                            'rgba(90, 220, 190, 0.9)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        }
                    }
                }
            }
        );
        
        // 柱状图 - 每日学习时长
        const studyDurationChart = new Chart(
            document.getElementById('studyDurationChart').getContext('2d'),
            {
                type: 'bar',
                data: {
                    labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'],
                    datasets: [{
                        label: 'Study Duration (Minutes)',
                        data: [45, 30, 60, 80, 40],
                        backgroundColor: [
                            'rgba(23, 96, 120, 0.9)',
                            'rgba(40, 140, 160, 0.9)',
                            'rgba(70, 190, 180, 0.9)',
                            'rgba(40, 210, 170, 0.9)',
                            'rgba(90, 220, 190, 0.9)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        }
                    }
                }
            }
        );
    }
    
    // // 设置分享按钮点击事件
    // function setupShareButton() {
    //     const shareButton = document.getElementById('shareButton');
    //     if (shareButton) {
    //         shareButton.addEventListener('click', function() {
    //             // 使用JavaScript手动显示模态窗口
    //             var myModal = new bootstrap.Modal(document.getElementById('shareModal'));
    //             myModal.show();
    //         });
    //     } else {
    //         console.error('Share button not found!');
    //     }
    // }
    
    // 设置用户选择功能
    function setupUserSelection() {
        const userSelect = document.getElementById('userSelect');
        const selectedUsers = document.getElementById('selectedUsers');
        
        if (userSelect && selectedUsers) {
            userSelect.addEventListener('change', function() {
                const selectedUser = this.value;
                const selectedOption = this.options[this.selectedIndex];
                
                if (selectedUser) {
                    // 检查用户是否已添加
                    if (!document.querySelector(`.remove-user[data-user="${selectedUser}"]`)) {
                        const userTag = document.createElement('div');
                        userTag.className = 'user-tag';
                        userTag.innerHTML = `
                            ${selectedOption.text}
                            <span class="remove-user" data-user="${selectedUser}">✕</span>
                        `;
                        selectedUsers.appendChild(userTag);
                        
                        // 重置选择
                        this.selectedIndex = 0;
                    }
                }
            });
            
            // 移除用户（使用事件委托）
            selectedUsers.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-user')) {
                    e.target.parentElement.remove();
                }
            });
        }
    }
    
    // 设置Done按钮点击事件
    function setupDoneButton() {
        const doneButton = document.getElementById('doneButton');
        const shareModal = document.getElementById('shareModal');
        
        if (doneButton && shareModal) {
            doneButton.addEventListener('click', function() {
                // 收集表单数据
                const form = document.getElementById('shareForm');
                const formData = new FormData(form);
                
                // 添加选中的用户
                const userTags = document.querySelectorAll('.user-tag');
                userTags.forEach(tag => {
                    const userName = tag.textContent.trim().replace('✕', '').trim();
                    formData.append('users[]', userName);
                });
                
                // 这里是预留的后端代码，实际部署时取消注释
                /*
                fetch('/share', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data);
                    const modal = bootstrap.Modal.getInstance(shareModal);
                    modal.hide();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
                */
                
                // 暂时只是隐藏模态窗口并显示一个成功消息
                // var modal = bootstrap.Modal.getOrCreateInstance(shareModal);
                // modal.hide();
                // console.log('Share form submitted');
                
                // // 可选：显示一个成功消息
                // alert('Data shared successfully!');
                const modal = bootstrap.Modal.getOrCreateInstance(shareModal);
                modal.hide();

            // 打印确认信息
                console.log('Share form submitted');

            // ✅ 显示确认弹窗
                alert('Data shared successfully!');
                });
        }
    }
</script>
{% endblock %}