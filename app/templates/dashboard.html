{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- <div class="dashboard-header">
        <h1>Data Analysis</h1>
        <div class="copyright">Â© 2025 CIST5505 Group 23</div>
    </div> -->

    <div class="stats-container">
        <div class="stat-card">
            <h3>Total Duration(Minutes)</h3>
            <div class="stat-value" id="total-duration">0</div>
        </div>
        
        <div class="stat-card">
            <h3>Today Learning (Minutes)</h3>
            <div class="stat-value" id="today-learning">0</div>
        </div>
        
        <div class="stat-card">
            <h3>Average Duration(Minutes)</h3>
            <div class="stat-value" id="average-duration">0</div>
        </div>

    </div>
    
    <div class="filter-section">
        <div class="filter-label">
            Filter: 
            <select id="period-filter" class="form-select">
                <option value="day">Today</option>
                <option value="week" selected>This Week</option>
                <option value="month">This Month</option>
            </select>
        </div>
        <div class="filter-label" style="margin-left: 20px;"> 
            Chart Type:
            <select id="chart-type-filter" class="form-select">
                <option value="duration" selected>Study Duration</option>
                <option value="task">Task Summary</option>
            </select>
        </div>
    </div>
    
    <div class="chart-container">
        <canvas id="study-chart"></canvas>
    </div>
    
    <div class="share-container">
        <button id="share-button" class="btn" onclick="openShareModal()">Share</button>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">Share Your Study Data</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div class="mb-4">
                    <h6 class="fw-bold mb-3">1. Select data you want to share</h6>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="dataType" id="totalTime" value="totalTime" checked>
                        <label class="form-check-label" for="totalTime">Total study time</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="dataType" id="averageTime" value="averageTime">
                        <label class="form-check-label" for="averageTime">Average study time</label>
                    </div>
                </div>
                
                <div>
                    <h6 class="fw-bold mb-3">2. Select users you want to share</h6>
                    <div class="mb-3">
                        <input type="text" id="userSearchInput" class="form-control" placeholder="Search users...">
                    </div>
                    <div id="userList" class="border rounded p-2 mb-3" style="max-height: 200px; overflow-y: auto;">
                        <div class="d-flex align-items-center justify-content-center p-3">
                            <div class="spinner-border spinner-border-sm text-secondary me-2" role="status"></div>
                            <span>Loading users...</span>
                        </div>
                    </div>
                    <div>
                        <label class="fw-bold mb-2">Selected users:</label>
                        <div id="selectedUsers" class="d-flex flex-wrap gap-2">
                            <span id="noUsersSelected" class="text-muted small">No users selected</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="doneButton" onclick="shareData()">Done</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let allUsers = [];
let selectedUserIds = [];
let currentUserUsername = ''; // To store current user's username
// Function to fetch current user's username (call this once)
async function fetchCurrentUserUsername() {
    if (currentUserUsername) return; // Already fetched
    try {
        const response = await fetch('/api/profile'); // Assuming /api/profile returns username
        if (response.ok) {
            const userData = await response.json();
            currentUserUsername = userData.username || 'A user';
        } else {
            currentUserUsername = 'A user'; // Fallback
        }
    } catch (error) {
        console.error('Error fetching current user username:', error);
        currentUserUsername = 'A user'; // Fallback
    }
}
window.initDashboardPage = function() {
    if (typeof initDashboardFeatures === 'function') {
        initDashboardFeatures(); // Call the main dashboard chart/stats loader
    } else {
        console.error('initDashboardFeatures function not found in dashboard.js');
        // Fallback or direct call to the old loadDashboardData if necessary
        // For example, if the old script's loadDashboardData is still relevant:
        // if (typeof window.loadDashboardData === 'function') {
        //     window.loadDashboardData();
        // }
    }
    fetchCurrentUserUsername(); // Fetch username when dashboard page initializes
};
// Function to open share modal
function openShareModal() {
    console.log('Opening share modal');
    
    // Reset selections
    selectedUserIds = [];
    if (document.getElementById('noUsersSelected')) {
        document.getElementById('noUsersSelected').style.display = 'block';
    }
    if (document.getElementById('selectedUsers')) {
        document.getElementById('selectedUsers').innerHTML = '<span id="noUsersSelected" class="text-muted small">No users selected</span>';
    }
    if (document.getElementById('userSearchInput')) {
        document.getElementById('userSearchInput').value = ''; // Clear search
    }
    
    // Initialize and show modal
    try {
        const shareModalElement = document.getElementById('shareModal');
        if (!shareModalElement) {
            console.error('Share modal element not found');
            return;
        }
        const shareModal = bootstrap.Modal.getInstance(shareModalElement) || new bootstrap.Modal(shareModalElement);
        loadUsers(); // Load users each time modal is opened to get fresh list
        shareModal.show();
    } catch (error) {
        console.error('Error showing modal:', error);
        alert('Error opening share dialog: ' + error.message);
    }
}

// Function to load users
function loadUsers() {
    console.log('Loading users');
    const userList = document.getElementById('userList');
    if (!userList) return;
    
    userList.innerHTML = `
        <div class="d-flex align-items-center justify-content-center p-3">
            <div class="spinner-border spinner-border-sm text-secondary me-2" role="status"></div>
            <span>Loading users...</span>
        </div>
    `;
    
    fetch('/api/users') // This API is in profile.py
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(users => {
            console.log('Users loaded:', users);
            allUsers = users; // Store all fetched users
            
            if (!Array.isArray(users) || users.length === 0) {
                userList.innerHTML = `<p class="text-center text-muted p-3">No other users available to share with.</p>`;
                return;
            }
            
            userList.innerHTML = ''; // Clear spinner/message
            
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'form-check mb-2';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input';
                checkbox.id = `user-${user.id}`;
                checkbox.value = user.id;
                // Ensure checkbox reflects current selection if modal is re-opened (though selections are reset now)
                checkbox.checked = selectedUserIds.includes(user.id); 
                
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        if (!selectedUserIds.includes(user.id)) {
                            selectedUserIds.push(user.id);
                        }
                    } else {
                        selectedUserIds = selectedUserIds.filter(id => id !== user.id);
                    }
                    updateSelectedUsers();
                });
                
                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = `user-${user.id}`;
                label.textContent = user.username;
                
                userItem.appendChild(checkbox);
                userItem.appendChild(label);
                userList.appendChild(userItem);
            });
            
            const searchInput = document.getElementById('userSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    filterUsers(searchTerm);
                });
            }
        })
        .catch(error => {
            console.error('Error loading users:', error);
            userList.innerHTML = `<p class="text-center text-danger p-3">Error loading users. Please try again.</p>`;
        });
}

// Filter users based on search term
function filterUsers(searchTerm) {
    const userCheckboxes = document.querySelectorAll('#userList .form-check');
    
    userCheckboxes.forEach(item => {
        const label = item.querySelector('.form-check-label');
        if (label) {
            const username = label.textContent.toLowerCase();
            item.style.display = username.includes(searchTerm) ? 'block' : 'none';
        }
    });
}

// Update selected users display
function updateSelectedUsers() {
    const selectedUsersContainer = document.getElementById('selectedUsers');
    const noUsersSelectedSpan = document.getElementById('noUsersSelected'); // Get the span directly

    if (!selectedUsersContainer) return;

    if (selectedUserIds.length === 0) {
        // Ensure the "No users selected" span is the only content and is visible
        selectedUsersContainer.innerHTML = '<span id="noUsersSelected" class="text-muted small">No users selected</span>';
        return;
    }
    
    selectedUsersContainer.innerHTML = ''; // Clear previous tags
    
    selectedUserIds.forEach(userId => {
        const user = allUsers.find(u => u.id === userId);
        if (!user) return;
        
        const tag = document.createElement('span');
        tag.className = 'badge bg-info text-dark me-2 mb-2';
        tag.style.display = 'inline-flex';
        tag.style.alignItems = 'center';
        tag.style.padding = '5px 10px';
        tag.style.borderRadius = '16px';
        
        tag.innerHTML = `
            ${user.username}
            <button type="button" class="btn-close btn-close-white ms-2" 
                    style="font-size: 0.5rem; filter: brightness(0.8);" aria-label="Remove"
                    onclick="removeUser(${userId})"></button>
        `;
        
        selectedUsersContainer.appendChild(tag);
    });
}

// Remove user from selection
function removeUser(userIdToRemove) {
    const checkbox = document.getElementById(`user-${userIdToRemove}`);
    if (checkbox) checkbox.checked = false;
    
    selectedUserIds = selectedUserIds.filter(id => id !== userIdToRemove);
    updateSelectedUsers();
}

// Share data with selected users by sending notifications
function shareData() {
    console.log('Share data function called');
    
    if (selectedUserIds.length === 0) {
        alert('Please select at least one user to share with.');
        return;
    }
    
    const dataTypeElement = document.querySelector('input[name="dataType"]:checked');
    if (!dataTypeElement) {
        alert('Please select the type of data to share.');
        return;
    }
    const dataTypeValue = dataTypeElement.value;
    let dataTypeText = "study data"; // Default
    if (dataTypeValue === "totalTime") {
        dataTypeText = "Total Study Time";
    } else if (dataTypeValue === "averageTime") {
        dataTypeText = "Average Study Time";
    }

    const notificationMessage = `shared their '${dataTypeText}' dashboard insights with you.`;

    console.log('Sharing data type:', dataTypeText, 'with user IDs:', selectedUserIds);
    console.log('Notification message:', notificationMessage);

    const doneButton = document.getElementById('doneButton');
    doneButton.disabled = true;
    doneButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sharing...';

    fetch('/api/notification', { // Using your notification API endpoint
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            // Add CSRF token header here if your app uses them for POST requests
            // 'X-CSRFToken': getCookie('csrftoken') // Example for Django
        },
        body: JSON.stringify({
            receiver_ids: selectedUserIds,
            content: notificationMessage
        })
    })
    .then(response => {
        // Regardless of ok status, try to parse JSON, as error might be in JSON format
        return response.json().then(data => ({ ok: response.ok, status: response.status, data }));
    })
    .then(result => {
        console.log('Share API response:', result);
        doneButton.disabled = false;
        doneButton.textContent = 'Done';

        if (result.ok && result.data.success) {
            const modalElement = document.getElementById('shareModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
            alert('Dashboard insights shared successfully via notification!');
        } else {
            alert('Failed to share dashboard insights: ' + (result.data.message || `HTTP Error ${result.status}` || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error sharing data:', error);
        doneButton.disabled = false;
        doneButton.textContent = 'Done';
        alert('An error occurred while sharing data. Please try again.');
    });
}

// Load dashboard features and set up event listeners
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard DOM loaded.');
    
    // Call the main dashboard initializer (which should be in dashboard.js)
    if (typeof window.initDashboardPage === 'function') {
        window.initDashboardPage();
    } else if (typeof initDashboardFeatures === 'function') { // Fallback if not wrapped
        initDashboardFeatures();
        fetchCurrentUserUsername();

    } else {
        console.warn('initDashboardPage or initDashboardFeatures not found. Dashboard might not fully initialize.');
    }
    
    // The filter event listeners for charts should be part of initDashboardFeatures in dashboard.js
    // If they were here, they would look like:
    // const periodFilter = document.getElementById('period-filter');
    // const chartTypeFilter = document.getElementById('chart-type-filter');
    // if (periodFilter && typeof window.loadDashboardData === 'function') periodFilter.addEventListener('change', window.loadDashboardData);
    // if (chartTypeFilter && typeof window.loadDashboardData === 'function') chartTypeFilter.addEventListener('change', window.loadDashboardData);
});

</script>
{% endblock %}