{% block extra_css %}
<style>
    .page-title {
        text-align: center;
        color: #C38D60;
        margin-bottom: 30px;
        font-size: 32px;
    }
    
    .stats-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40px;
        flex-wrap: wrap;
    }
    
    .stat-card {
        background-color: #F3E7DD;
        border-radius: 10px;
        padding: 20px;
        width: 23%;
        text-align: center;
    }
    
    .stat-label {
        font-size: 16px;
        color: #333;
        margin-bottom: 10px;
    }
    
    .stat-value {
        font-size: 40px;
        font-weight: bold;
        color: #C38D60;
    }
    
    .filters-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
    }
    
    .filter-label {
        color: #C38D60;
        font-size: 16px;
    }
    
    .charts-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40px;
        flex-wrap: wrap;
    }
    
    .chart-container {
        width: 48%;
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        height: 350px;
    }
    
    .btn-container {
        text-align: center;
        margin: 30px 0;
    }
    
    .share-btn {
        background-color: #C38D60;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 10px 30px;
        font-size: 16px;
        cursor: pointer;
    }
    
    .share-btn:hover {
        background-color: #b07a50;
    }
    
    /* Modal styles */
    .modal-content {
        background-color: #c69c6d;
        border-radius: 8px;
        padding: 15px;
    }
    
    .modal-header {
        border-bottom: none;
        padding-bottom: 0;
    }
    
    .modal-title {
        width: 100%;
        text-align: center;
        font-size: 24px;
        color: #000;
    }
    
    .modal-body {
        padding: 20px 15px;
    }
    
    .section-title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .radio-option {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .radio-option input[type="radio"] {
        margin-right: 10px;
        transform: scale(1.2);
    }
    
    .select-container {
        position: relative;
        margin-bottom: 15px;
    }
    
    .form-select {
        border-radius: 20px;
        padding: 10px;
    }
    
    .selected-users {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    
    .user-tag {
        display: flex;
        align-items: center;
        background-color: white;
        border-radius: 20px;
        padding: 5px 12px;
        font-size: 14px;
    }
    
    .remove-user {
        margin-left: 8px;
        cursor: pointer;
        color: #888;
        font-size: 16px;
    }
    
    .modal-footer {
        border-top: none;
        justify-content: center;
        padding-top: 0;
    }
    
    .btn-done {
        background-color: #26a69a;
        color: white;
        border-radius: 20px;
        padding: 8px 30px;
    }
    
    .btn-cancel {
        background-color: white;
        color: black;
        border-radius: 20px;
        padding: 8px 30px;
    }
    
    @media (max-width: 768px) {
        .stat-card {
            width: 48%;
            margin-bottom: 15px;
        }
        
        .chart-container {
            width: 100%;
            margin-bottom: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<h1 class="page-title">Data Analysis</h1>

<div class="stats-row">
    <div class="stat-card">
        <div class="stat-label">Total Duration(Minutes)</div>
        <div class="stat-value">50</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Today Learning (Minutes)</div>
        <div class="stat-value">20</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Average Duration(Minutes)</div>
        <div class="stat-value">15</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Today Learning (Minutes)</div>
        <div class="stat-value">20</div>
    </div>
</div>

<div class="filters-row">
    <div>
        <span class="filter-label">Filter : This Month</span>
    </div>
    <div>
        <span class="filter-label">Filter : This Month</span>
    </div>
</div>

<div class="charts-row">
    <div class="chart-container">
        <canvas id="studyPlanChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="studyDurationChart"></canvas>
    </div>
</div>

<div class="btn-container">
    <button type="button" class="share-btn" data-bs-toggle="modal" data-bs-target="#shareModal">
        Share
    </button>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">Share Your Study Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="shareForm">
                    <div class="mb-4">
                        <h3 class="section-title">1. Select data you want to share</h3>
                        <div class="radio-option">
                            <input type="radio" id="totalStudyTime" name="dataType" value="totalStudyTime" checked>
                            <label for="totalStudyTime">Total study time</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="averageStudyTime" name="dataType" value="averageStudyTime">
                            <label for="averageStudyTime">Average study time</label>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="section-title">2. Select users you want to share</h3>
                        <div class="select-container">
                            <select class="form-select" id="userSelect">
                                <option value="" disabled selected>Select users</option>
                                <option value="alice">Alice</option>
                                <option value="bob">Bob</option>
                                <option value="celia">Celia</option>
                                <option value="david">David</option>
                                <option value="betty">Betty</option>
                            </select>
                        </div>
                        
                        <div class="selected-users" id="selectedUsers">
                            <div class="user-tag">
                                Celia
                                <span class="remove-user" data-user="celia">✕</span>
                            </div>
                            <div class="user-tag">
                                Betty
                                <span class="remove-user" data-user="betty">✕</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-done" id="doneButton">Done</button>
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    // check Chart.js 
    window.onload = function() {
        console.log('Window loaded');
        if (typeof Chart === 'undefined') {
            console.error('Chart.js fail');
            alert('Chart libraries are not loaded correctly, some functions may not be available');
            return;
        }
        
        console.log('Chart.js ready:', typeof Chart);
        
        // wait dom 
        setTimeout(function() {
            // initial
            initializeCharts();
            
            // 
            setupUserSelection();
            
            // 
            setupDoneButton();
        }, 200);
    };
    
    // 
    function initializeCharts() {
        try {
            // pie
            const pieCtx = document.getElementById('studyPlanChart');
            if (pieCtx) {
                console.log('Creating pie chart...');
                const planStatusChart = new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Open', 'Completed', 'Deleted', 'In Progress', 'Late'],
                        datasets: [{
                            data: [5, 3, 1, 4, 2],
                            backgroundColor: [
                                'rgba(23, 96, 120, 0.9)',
                                'rgba(40, 140, 160, 0.9)',
                                'rgba(70, 190, 180, 0.9)',
                                'rgba(40, 210, 170, 0.9)',
                                'rgba(90, 220, 190, 0.9)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: false
                            }
                        }
                    }
                });
            } else {
                console.error('can not find');
            }
            
            // bar
            const barCtx = document.getElementById('studyDurationChart');
            if (barCtx) {
                console.log('Creating bar chart...');
                const studyDurationChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'],
                        datasets: [{
                            label: 'Study Duration (Minutes)',
                            data: [45, 30, 60, 80, 40],
                            backgroundColor: [
                                'rgba(23, 96, 120, 0.9)',
                                'rgba(40, 140, 160, 0.9)',
                                'rgba(70, 190, 180, 0.9)',
                                'rgba(40, 210, 170, 0.9)',
                                'rgba(90, 220, 190, 0.9)'
                            ],
                            borderWidth: 0,
                            barThickness: 40
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    display: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: false
                            }
                        }
                    }
                });
            } else {
                console.error('can not find');
            }
            
            console.log('Charts initialized');
            
        } catch (error) {
            console.error('Error initializing charts:', error);
        }
    }
    
    // 
    function setupUserSelection() {
        const userSelect = document.getElementById('userSelect');
        const selectedUsers = document.getElementById('selectedUsers');
        
        if (userSelect && selectedUsers) {
            userSelect.addEventListener('change', function() {
                const selectedUser = this.value;
                const selectedOption = this.options[this.selectedIndex];
                
                if (selectedUser) {
                    // 
                    if (!document.querySelector(`.remove-user[data-user="${selectedUser}"]`)) {
                        const userTag = document.createElement('div');
                        userTag.className = 'user-tag';
                        userTag.innerHTML = `
                            ${selectedOption.text}
                            <span class="remove-user" data-user="${selectedUser}">✕</span>
                        `;
                        selectedUsers.appendChild(userTag);
                        
                        // 
                        this.selectedIndex = 0;
                    }
                }
            });
            
            // 
            selectedUsers.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-user')) {
                    e.target.parentElement.remove();
                }
            });
        }
    }
    
    // 
    function setupDoneButton() {
        const doneButton = document.getElementById('doneButton');
        
        if (doneButton) {
            doneButton.addEventListener('click', function() {
                try {
                    // 
                    const shareModal = document.getElementById('shareModal');
                    
                    //
                    let modalInstance;
                    if (window.bootstrap && typeof bootstrap.Modal !== 'undefined') {
                        modalInstance = bootstrap.Modal.getInstance(shareModal);
                        
                        if (!modalInstance) {
                            modalInstance = new bootstrap.Modal(shareModal);
                        }
                        
                        // 
                        modalInstance.hide();
                    } else {
                        // 
                        if (window.jQuery) {
                            jQuery(shareModal).modal('hide');
                        } else {
                            // 
                            shareModal.classList.remove('show');
                            shareModal.style.display = 'none';
                            
                            // 
                            const modalBackdrops = document.getElementsByClassName('modal-backdrop');
                            if (modalBackdrops.length > 0) {
                                for (let i = 0; i < modalBackdrops.length; i++) {
                                    modalBackdrops[i].remove();
                                }
                            }
                            
                            // remove body overflow hidden
                            document.body.classList.remove('modal-open');
                            document.body.style.overflow = '';
                            document.body.style.paddingRight = '';
                        }
                    }
                    
                    // 
                    console.log('Share form submitted');
                    alert('Data shared successfully!');
                    
                } catch (error) {
                    console.error('Error in doneButton handler:', error);
                }
            });
        }
    }
</script>
{% endblock %}